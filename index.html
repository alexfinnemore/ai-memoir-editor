<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Memoir Editor</title>
    <style>
        /* Previous styles remain the same */
        .highlight-grammar {
            background-color: #90EE90;
            padding: 2px 4px;
            border-radius: 2px;
        }
        .highlight-spelling {
            background-color: #FFB6B6;
            padding: 2px 4px;
            border-radius: 2px;
        }
        .highlight-other {
            background-color: #FFE5B4;
            padding: 2px 4px;
            border-radius: 2px;
        }

        /* Rest of your existing styles */
    </style>
</head>
<body>
    <!-- Previous HTML remains the same -->

    <script>
        // Previous functions remain the same

        function findDifference(str1, str2) {
            let i = 0;
            let j = str1.length - 1;
            let k = str2.length - 1;
            let start = 0;
            let end1 = str1.length;
            let end2 = str2.length;

            // Find first difference from start
            while (i < str1.length && i < str2.length && str1[i] === str2[i]) {
                i++;
            }
            start = i;

            // Find first difference from end
            while (j >= i && k >= i && str1[j] === str2[k]) {
                j--;
                k--;
            }
            end1 = j + 1;
            end2 = k + 1;

            return {
                before: {
                    prefix: str1.slice(0, start),
                    changed: str1.slice(start, end1),
                    suffix: str1.slice(end1)
                },
                after: {
                    prefix: str2.slice(0, start),
                    changed: str2.slice(start, end2),
                    suffix: str2.slice(end2)
                }
            };
        }

        function getHighlightClass(type) {
            type = type.toLowerCase();
            if (type.includes('grammar')) return 'highlight-grammar';
            if (type.includes('spelling')) return 'highlight-spelling';
            return 'highlight-other';
        }

        function displayChanges(result) {
            // Display AI-reported changes
            const originalText = document.getElementById('manuscript-input').value;
            const editedText = result.editedText;

            const aiChangesHtml = result.aiChanges.map(change => {
                const beforeLineNum = getLineNumberForText(originalText, change.before);
                const lineRef = beforeLineNum ? `<span class="change-line-ref">Line ${beforeLineNum}</span>` : '';
                
                const diff = findDifference(change.before, change.after);
                const highlightClass = getHighlightClass(change.type);

                const beforeHtml = `${diff.before.prefix}<span class="${highlightClass}">${diff.before.changed}</span>${diff.before.suffix}`;
                const afterHtml = `${diff.after.prefix}<span class="${highlightClass}">${diff.after.changed}</span>${diff.after.suffix}`;

                return `
                    <div class="change-item">
                        <div class="change-type">${change.type} ${lineRef}</div>
                        <div class="change-text">Before: ${beforeHtml}</div>
                        <div class="change-text">After: ${afterHtml}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('ai-changes').innerHTML = aiChangesHtml;

            // Display diff changes - could also add highlighting here if needed
            const diffChangesHtml = result.diffChanges.map(change => `
                <div class="change-item">
                    <div class="change-type">${change.type}</div>
                    <div class="change-text">${change.text}</div>
                    <div>Context: ${change.context}</div>
                </div>
            `).join('');
            document.getElementById('diff-changes').innerHTML = diffChangesHtml;

            // Update edited text line numbers
            updateLineNumbers(editedText, document.getElementById('edited-line-numbers'));
        }

        // Rest of your script remains the same
    </script>
</body>
</html>