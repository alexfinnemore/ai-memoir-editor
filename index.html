<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Memoir Editor</title>
    <style>
        /* Previous styles remain the same */
        .highlight-grammar { 
            background-color: #90EE90; 
            padding: 2px;
            border-radius: 2px;
        }
        .highlight-spelling { 
            background-color: #FFB6B6; 
            padding: 2px;
            border-radius: 2px;
        }
        .highlight-other { 
            background-color: #FFE5B4; 
            padding: 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <!-- Previous HTML remains the same -->

    <script>
        function applyHighlightsToEditedText(text, changes) {
            let highlightedText = text;
            const sortedChanges = changes.slice().sort((a, b) => {
                const indexA = text.indexOf(a.after);
                const indexB = text.indexOf(b.after);
                return indexB - indexA;  // Process from end to start
            });

            for (const change of sortedChanges) {
                const highlightClass = getHighlightClass(change.type);
                const highlightedChange = `<span class="${highlightClass}">${change.after}</span>`;
                const index = highlightedText.indexOf(change.after);
                if (index !== -1) {
                    highlightedText = 
                        highlightedText.slice(0, index) + 
                        highlightedChange + 
                        highlightedText.slice(index + change.after.length);
                }
            }
            return highlightedText;
        }

        function displayChanges(result) {
            // Previous change display code remains the same

            // Apply highlights to main edited text
            const highlightedEditedText = applyHighlightsToEditedText(result.editedText, result.aiChanges);
            document.getElementById('edited-display').innerHTML = highlightedEditedText;
        }

        // Rest of your script remains the same
    </script>
</body>
</html>