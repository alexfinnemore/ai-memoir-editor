<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Memoir Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typo-js/1.2.3/typo.js"></script>
    <style>
        /* Previous styles remain the same */
        .spellcheck-error {
            text-decoration: underline wavy red;
            text-decoration-skip-ink: none;
        }
        /* Rest of your existing styles */
    </style>
</head>
<body>
    <h1>AI Memoir Editor</h1>
    
    <div class="editor-container">
        <div class="editor-panel">
            <div class="panel-header">
                <h2>Original Text</h2>
                <span id="original-word-count" class="word-count">0 words</span>
            </div>
            <div id="original-display" class="text-area" contenteditable="true" spellcheck="false"></div>
        </div>
        <div class="editor-panel">
            <div class="panel-header">
                <h2>Edited Text</h2>
                <span id="edited-word-count" class="word-count">0 words</span>
            </div>
            <div id="edited-display" class="text-area" contenteditable="false" spellcheck="false"></div>
        </div>
    </div>
    
    <div>
        <button id="analyze-btn">Edit Text</button>
    </div>

    <div id="status" style="display: none;"></div>
    
    <div id="changes-list">
        <h2>Changes Made</h2>
        <div id="changes-content"></div>
    </div>

    <script>
        let dictionary;

        // Initialize dictionary
        async function initDictionary() {
            try {
                const affData = await fetch('https://raw.githubusercontent.com/wooorm/dictionaries/main/dictionaries/en/index.aff').then(r => r.text());
                const dicData = await fetch('https://raw.githubusercontent.com/wooorm/dictionaries/main/dictionaries/en/index.dic').then(r => r.text());
                dictionary = new Typo('en_US', affData, dicData);
                // Initial spellcheck after dictionary loads
                spellcheckContent();
            } catch (error) {
                console.error('Failed to load dictionary:', error);
            }
        }

        // Spellcheck the content and mark errors
        function spellcheckContent() {
            if (!dictionary) return;

            const checkText = (element) => {
                const text = element.textContent;
                const words = text.match(/\w+/g) || [];
                let html = text;

                words.forEach(word => {
                    if (!dictionary.check(word)) {
                        const regex = new RegExp(`\\b${word}\\b`, 'g');
                        html = html.replace(regex, `<span class="spellcheck-error">${word}</span>`);
                    }
                });

                element.innerHTML = html;
            };

            checkText(document.getElementById('original-display'));
            checkText(document.getElementById('edited-display'));
        }

        function countWords(text) {
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            statusDiv.className = isError ? 'error' : 'success';
        }

        function displayChanges(changes) {
            const changesContent = document.getElementById('changes-content');
            changesContent.innerHTML = changes.map(change => `
                <div class="change-item">
                    <div class="change-type">${change.type}</div>
                    <div class="change-text">Before: ${change.before}</div>
                    <div class="change-text">After: ${change.after}</div>
                    <div class="change-details">${change.explanation}</div>
                </div>
            `).join('');
        }

        function updateWordCount() {
            const text = document.getElementById('original-display').textContent;
            const count = countWords(text);
            document.getElementById('original-word-count').textContent = `${count} words`;
        }

        document.getElementById('original-display').addEventListener('input', () => {
            updateWordCount();
            spellcheckContent();
        });

        document.getElementById('analyze-btn').addEventListener('click', async () => {
            const manuscriptText = document.getElementById('original-display').textContent;
            const analyzeBtn = document.getElementById('analyze-btn');
            const editedDisplay = document.getElementById('edited-display');

            if (!manuscriptText.trim()) {
                showStatus('Please enter some text to edit', true);
                return;
            }

            analyzeBtn.disabled = true;
            showStatus('Editing text...');
            editedDisplay.textContent = '';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: manuscriptText })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to edit text');
                }

                if (result.success) {
                    showStatus('Editing complete');
                    editedDisplay.textContent = result.editedText;
                    spellcheckContent();
                    displayChanges(result.changes);
                    
                    const editedCount = countWords(result.editedText);
                    document.getElementById('edited-word-count').textContent = `${editedCount} words`;
                } else {
                    throw new Error(result.error || 'Editing failed');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, true);
                console.error('Analysis error:', error);
            } finally {
                analyzeBtn.disabled = false;
            }
        });

        // Initialize
        initDictionary();
        updateWordCount();
    </script>
</body>
</html>