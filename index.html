<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Memoir Editor</title>
    <style>
        /* Previous styles remain */
        
        /* Original text highlights */
        .original-highlight {
            background-color: #ffe6e6;
            padding: 2px;
            border-radius: 2px;
        }

        /* Edited text highlights by type */
        .highlight-grammar { 
            background-color: #90EE90; 
            padding: 2px;
            border-radius: 2px;
        }
        .highlight-spelling { 
            background-color: #FFB6B6; 
            padding: 2px;
            border-radius: 2px;
        }
        .highlight-style { 
            background-color: #FFE5B4; 
            padding: 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <!-- Previous HTML structure remains the same -->

    <script>
        function getHighlightClass(type) {
            type = type.toLowerCase();
            if (type.includes('grammar')) return 'highlight-grammar';
            if (type.includes('spelling')) return 'highlight-spelling';
            return 'highlight-style';
        }

        function highlightOriginalText(text, changes) {
            let highlightedText = text;
            // Sort changes by length (longest first) to handle nested changes
            const sortedChanges = changes.slice().sort((a, b) => b.before.length - a.before.length);
            
            // Highlight each change in the original text
            sortedChanges.forEach(change => {
                const regex = new RegExp(change.before.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                highlightedText = highlightedText.replace(
                    regex,
                    `<span class="original-highlight">${change.before}</span>`
                );
            });
            
            return highlightedText;
        }

        function highlightEditedText(text, changes) {
            let highlightedText = text;
            // Sort changes by length (longest first) to handle nested changes
            const sortedChanges = changes.slice().sort((a, b) => b.after.length - a.after.length);
            
            // Highlight each change in the edited text
            sortedChanges.forEach(change => {
                const highlightClass = getHighlightClass(change.type);
                const regex = new RegExp(change.after.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                highlightedText = highlightedText.replace(
                    regex,
                    `<span class="${highlightClass}">${change.after}</span>`
                );
            });
            
            return highlightedText;
        }

        function displayChanges(result) {
            // Display AI-reported changes
            const aiChangesHtml = result.aiChanges.map(change => `
                <div class="change-item">
                    <div class="change-type">${change.type}</div>
                    <div>Before: <span class="original-highlight">${change.before}</span></div>
                    <div>After: <span class="${getHighlightClass(change.type)}">${change.after}</span></div>
                </div>
            `).join('');
            document.getElementById('ai-changes').innerHTML = aiChangesHtml;

            // Highlight changes in both texts
            document.getElementById('manuscript-input').innerHTML = 
                highlightOriginalText(result.originalText, result.aiChanges);
            document.getElementById('edited-display').innerHTML = 
                highlightEditedText(result.editedText, result.aiChanges);
        }

        // Rest of your script remains the same
    </script>
</body>
</html>